# AWS WAF Security Analysis Tool

A comprehensive Python application for analyzing AWS WAF (Web Application Firewall) configurations and logs. This tool helps security teams identify security gaps, optimize rules, reduce false positives, and improve their overall security posture.

## Features

- **Zero Persistent Connections**: Fetches all data once and stores it locally in DuckDB
- **Multi-Account Support**: Organized directory structure with account-specific data separation
- **Multi-Source Log Collection**: Supports both CloudWatch Logs and S3 as log sources
- **Auto-Detect CloudWatch Logs**: Automatically discovers log groups from Web ACL configurations
- **Flexible Time Windows**: Today, yesterday, past week, 3/6 months, or custom date ranges
- **Comprehensive Analysis**: Analyzes WAF configurations, rules, traffic patterns, and attack types
- **Rich Excel Reports**: Generates multi-sheet Excel workbooks with visualizations
- **LLM-Ready**: Includes prompt templates for AI-powered security analysis
- **Data-Rich Prompt Exports**: Automatically injects real metrics, rule data, and attack summaries into every exported prompt template for immediate AI consumption
- **Raw Log Archives**: Stores each CloudWatch fetch as JSONL under `raw-logs/{alias}_{account_id}/` for offline validation and troubleshooting
- **Modular Architecture**: Clean separation of concerns for easy maintenance and extension

## Architecture

### Directory Structure

```
aws-waf-analyzer/
â”œâ”€â”€ config/                                 # Configuration files
â”‚   â”œâ”€â”€ prompts/                           # LLM prompt templates (version controlled)
â”‚   â”‚   â””â”€â”€ comprehensive_waf_analysis.md  # Master prompt with all analysis sections
â”‚   â””â”€â”€ waf_schema.json                    # WAF log schema definition
â”œâ”€â”€ src/                                   # Source code
â”‚   â”œâ”€â”€ fetchers/                         # Data fetching modules
â”‚   â”œâ”€â”€ processors/                       # Data processing modules
â”‚   â”œâ”€â”€ storage/                          # Database management
â”‚   â”œâ”€â”€ reporters/                        # Report generation
â”‚   â”œâ”€â”€ llm/                              # LLM analysis integration
â”‚   â”‚   â”œâ”€â”€ providers/                    # LLM provider implementations (Bedrock Claude/OpenAI)
â”‚   â”‚   â”œâ”€â”€ prompt_injector.py           # Data injection into prompt templates
â”‚   â”‚   â”œâ”€â”€ analyzer.py                  # Main LLM analyzer coordinator
â”‚   â”‚   â””â”€â”€ response_parser.py           # Parse LLM markdown responses
â”‚   â”œâ”€â”€ utils/                            # Utility functions
â”‚   â””â”€â”€ main.py                           # Main orchestration script
â”œâ”€â”€ data/{alias}_{account_id}/             # Account-specific DuckDB files (auto-created)
â”œâ”€â”€ output/{alias}_{account_id}/           # Account-specific Excel reports (auto-created)
â”œâ”€â”€ logs/{alias}_{account_id}/             # Account-specific application logs (auto-created)
â”œâ”€â”€ exported-prompt/{alias}_{account_id}/  # Filled prompts with WAF data (gitignored, auto-created)
â”œâ”€â”€ raw-logs/{alias}_{account_id}/         # Archived raw CloudWatch log exports (gitignored)
â”œâ”€â”€ requirements.txt                       # Python dependencies
â””â”€â”€ README.md                              # This file
```

### System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          AWS WAF Analyzer                               â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   AWS CLI   â”‚                                      â”‚     User     â”‚ â”‚
â”‚  â”‚   Profile   â”‚                                      â”‚  Interface   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                                    â”‚         â”‚
â”‚         â”‚ Credentials                          CLI Argumentsâ”‚         â”‚
â”‚         â–¼                                                    â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      Main Orchestrator                           â”‚ â”‚
â”‚  â”‚                        (main.py)                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜ â”‚
â”‚      â”‚         â”‚              â”‚              â”‚              â”‚             â”‚    â”‚
â”‚      â–¼         â–¼              â–¼              â–¼              â–¼             â–¼    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Utils  â”‚â”‚ LLM â”‚   â”‚ Fetchers â”‚   â”‚Processorsâ”‚   â”‚ Storage â”‚   â”‚Reportâ”‚ â”‚
â”‚  â”‚        â”‚â”‚     â”‚   â”‚          â”‚   â”‚          â”‚   â”‚         â”‚   â”‚  ers â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  AWS   â”‚â”‚Anlyzâ”‚   â”‚CloudWatchâ”‚   â”‚   Log    â”‚   â”‚ DuckDB  â”‚   â”‚ Excelâ”‚ â”‚
â”‚  â”‚Helpers â”‚â”‚ er  â”‚   â”‚ Fetcher  â”‚   â”‚  Parser  â”‚   â”‚ Manager â”‚   â”‚  Gen â”‚ â”‚
â”‚  â”‚        â”‚â”‚     â”‚   â”‚          â”‚   â”‚          â”‚   â”‚         â”‚   â”‚      â”‚ â”‚
â”‚  â”‚  Time  â”‚â”‚Prompt   â”‚   S3     â”‚   â”‚  Config  â”‚   â”‚ Schema  â”‚   â”‚ Viz  â”‚ â”‚
â”‚  â”‚Helpers â”‚â”‚Inject   â”‚ Fetcher  â”‚   â”‚Processor â”‚   â”‚ Queries â”‚   â”‚Helperâ”‚ â”‚
â”‚  â”‚        â”‚â”‚     â”‚   â”‚          â”‚   â”‚          â”‚   â”‚         â”‚   â”‚      â”‚ â”‚
â”‚  â”‚        â”‚â”‚Parsrâ”‚   â”‚          â”‚   â”‚ Metrics  â”‚   â”‚         â”‚   â”‚      â”‚ â”‚
â”‚  â”‚        â”‚â”‚     â”‚   â”‚          â”‚   â”‚Calculatorâ”‚   â”‚         â”‚   â”‚      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”¬â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚      â”‚        â”‚           â”‚              â”‚              â”‚             â”‚    â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    External Dependencies      â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚  â€¢ AWS WAFv2 API             â”‚
                    â”‚  â€¢ CloudWatch Logs API       â”‚
                    â”‚  â€¢ S3 API                    â”‚
                    â”‚  â€¢ AWS Bedrock API (LLM)     â”‚
                    â”‚  â€¢ DuckDB (local)            â”‚
                    â”‚  â€¢ Matplotlib (charts)       â”‚
                    â”‚  â€¢ OpenPyXL (Excel)          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Start CLI  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: Initialization                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Parse Args   â”‚â”€â”€â”€â”€â–¶â”‚ Verify AWS  â”‚â”€â”€â”€â”€â–¶â”‚ Initialize DB    â”‚    â”‚
â”‚  â”‚              â”‚     â”‚ Credentials â”‚     â”‚ (Create Schema)  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: Configuration Fetching (Optional: --skip-config)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ List WAF  â”‚â”€â”€â”€â”€â–¶â”‚  Get Each  â”‚â”€â”€â”€â”€â–¶â”‚   Store in  â”‚              â”‚
â”‚  â”‚ Web ACLs  â”‚     â”‚  Web ACL   â”‚     â”‚   Database  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚       â”‚                   â”‚                    â”‚                    â”‚
â”‚       â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                    â”‚
â”‚       â–¼            â–¼               â–¼           â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚Resourcesâ”‚  â”‚ Rules  â”‚    â”‚ Logging â”‚  â”‚ Store  â”‚               â”‚
â”‚  â”‚  (ALB,  â”‚  â”‚        â”‚    â”‚ Config  â”‚  â”‚ to DB  â”‚               â”‚
â”‚  â”‚API, CF) â”‚  â”‚        â”‚    â”‚         â”‚  â”‚        â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 3: Log Collection (Optional: --skip-logs)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  User Selects Source:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              OR              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  CloudWatch  â”‚                               â”‚      S3      â”‚   â”‚
â”‚  â”‚    Logs      â”‚                               â”‚    Bucket    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                              â”‚           â”‚
â”‚         â–¼                                              â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Filter Log      â”‚                         â”‚ List Objects    â”‚  â”‚
â”‚  â”‚ Events (3-6mo)  â”‚                         â”‚ (Date Prefixes) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                           â”‚            â”‚
â”‚           â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â–¼              â–¼                                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚      â”‚   Parse Logs           â”‚                                   â”‚
â”‚      â”‚   (Normalize Schema)   â”‚                                   â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                 â”‚                                                  â”‚
â”‚                 â–¼                                                  â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚      â”‚  Bulk Insert to DB     â”‚                                   â”‚
â”‚      â”‚  (Chunked: 10k/batch)  â”‚                                   â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 4: Analysis & Metrics                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  SQL Queries on DuckDB                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚ Summary  â”‚ â”‚   Rule   â”‚ â”‚   Geo    â”‚ â”‚  Attack  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ Metrics  â”‚ â”‚Effective â”‚ â”‚  Threat  â”‚ â”‚   Type   â”‚ ... â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                  â”‚ Aggregate All Metrics â”‚                         â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 5: Report Generation                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Create Excel Workbook (6 Sheets)                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚Executive â”‚ â”‚Inventory â”‚ â”‚ Traffic  â”‚ â”‚   Rule   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ Summary  â”‚ â”‚          â”‚ â”‚ Analysis â”‚ â”‚Effective â”‚ ... â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                  â”‚ Generate Charts       â”‚                         â”‚
â”‚                  â”‚ (Matplotlib â†’ PNG)    â”‚                         â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                             â”‚                                       â”‚
â”‚                             â–¼                                       â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                  â”‚ Embed Charts in Excel â”‚                         â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                             â”‚                                       â”‚
â”‚                             â–¼                                       â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                  â”‚ Save .xlsx File       â”‚                         â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚  Complete!       â”‚
                                          â”‚                  â”‚
                                          â”‚  Outputs:        â”‚
                                          â”‚  â€¢ DuckDB file   â”‚
                                          â”‚  â€¢ Excel report  â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Module Dependencies

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         main.py                                â”‚
â”‚                    (Orchestrator)                              â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚        â”‚        â”‚        â”‚        â”‚        â”‚
    â”‚        â”‚        â”‚        â”‚        â”‚        â”‚
    â–¼        â–¼        â–¼        â–¼        â–¼        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ utils/ â”‚ â”‚fet â”‚ â”‚proc â”‚ â”‚stora â”‚ â”‚repor â”‚ â”‚ config/â”‚
â”‚        â”‚ â”‚cherâ”‚ â”‚essorâ”‚ â”‚ ge/  â”‚ â”‚ters/ â”‚ â”‚        â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚        â”‚       â”‚        â”‚        â”‚
    â”‚        â”‚       â”‚        â”‚        â”‚
    â–¼        â–¼       â–¼        â–¼        â–¼

aws_helpers   cloudwatch  log_parser   duckdb    excel_gen
time_helpers  s3_fetcher  config_proc  manager   viz_helpers
                          metrics_calc

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dependency Flow                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Fetchers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Utils (aws_helpers, time_helpers) â”‚
â”‚     â”‚                                                         â”‚
â”‚     â””â”€â”€â”€â”€â”€â–¶ Processors â”€â”€â–¶ Utils (time_helpers)             â”‚
â”‚                  â”‚                                            â”‚
â”‚                  â””â”€â”€â”€â”€â”€â–¶ Storage (duckdb_manager)            â”‚
â”‚                              â”‚                                â”‚
â”‚                              â””â”€â”€â”€â”€â”€â–¶ Reporters                â”‚
â”‚                                         â”‚                     â”‚
â”‚                                         â””â”€â”€â–¶ Utils            â”‚
â”‚                                                               â”‚
â”‚  Config (waf_schema.json) â”€â”€â–¶ Processors (log_parser)       â”‚
â”‚  Config (prompts/*.md)    â”€â”€â–¶ Reporters (reference)         â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DuckDB Schema                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      web_acls           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ web_acl_id (PK)       â”‚â—€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ name                  â”‚       â”‚
â”‚ â€¢ scope                 â”‚       â”‚
â”‚ â€¢ default_action        â”‚       â”‚
â”‚ â€¢ capacity              â”‚       â”‚
â”‚ â€¢ created_at            â”‚       â”‚
â”‚ â€¢ updated_at            â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â–³                        â”‚
         â”‚                        â”‚
         â”‚ (1:N)                  â”‚ (1:N)
         â”‚                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      rules           â”‚  â”‚  resource_associations   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ rule_id (PK)       â”‚  â”‚ â€¢ association_id (PK)    â”‚
â”‚ â€¢ web_acl_id (FK) â”€â”€â”€â”˜  â”‚ â€¢ web_acl_id (FK) â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â€¢ name               â”‚  â”‚ â€¢ resource_arn           â”‚
â”‚ â€¢ priority           â”‚  â”‚ â€¢ resource_type          â”‚
â”‚ â€¢ rule_type          â”‚  â”‚   (ALB/API_GW/CF)        â”‚
â”‚ â€¢ action             â”‚  â”‚ â€¢ created_at             â”‚
â”‚ â€¢ statement          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–³
         â”‚ (1:N)
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ logging_configurations    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ config_id (PK)          â”‚
â”‚ â€¢ web_acl_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â€¢ destination_type        â”‚
â”‚   (CloudWatch/S3/Firehose)â”‚
â”‚ â€¢ destination_arn         â”‚
â”‚ â€¢ sampling_rate           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      waf_logs                               â”‚
â”‚                 (Main Analytics Table)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ log_id (PK, Auto-increment)                               â”‚
â”‚ â€¢ timestamp                    [INDEXED]                    â”‚
â”‚ â€¢ web_acl_id                   [INDEXED]                    â”‚
â”‚ â€¢ action                       [INDEXED]                    â”‚
â”‚ â€¢ client_ip                    [INDEXED]                    â”‚
â”‚ â€¢ country                      [INDEXED]                    â”‚
â”‚ â€¢ uri                                                        â”‚
â”‚ â€¢ http_method                                               â”‚
â”‚ â€¢ http_status                                               â”‚
â”‚ â€¢ terminating_rule_id          [INDEXED]                    â”‚
â”‚ â€¢ terminating_rule_type                                     â”‚
â”‚ â€¢ rule_group_list (JSON)                                    â”‚
â”‚ â€¢ labels (JSON)                                             â”‚
â”‚ â€¢ ja3_fingerprint                                           â”‚
â”‚ â€¢ ja4_fingerprint                                           â”‚
â”‚ â€¢ user_agent                                                â”‚
â”‚ â€¢ raw_log (JSON - full record)                             â”‚
â”‚ â€¢ created_at                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Indexes for Performance                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ idx_logs_timestamp                                       â”‚
â”‚  â€¢ idx_logs_web_acl                                        â”‚
â”‚  â€¢ idx_logs_action                                         â”‚
â”‚  â€¢ idx_logs_client_ip                                      â”‚
â”‚  â€¢ idx_logs_country                                        â”‚
â”‚  â€¢ idx_logs_terminating_rule                               â”‚
â”‚  â€¢ idx_associations_web_acl                                â”‚
â”‚  â€¢ idx_rules_web_acl                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Execution Flow (Sequence Diagram)

```
User          Main.py      Fetchers     Processors    Storage      Reporters
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚â”€ Run CLI â”€â”€â”€â–¶â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚â”€ Verify â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚             â”‚
  â”‚              â”‚   Creds     â”‚             â”‚      AWS   â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚    Helpers â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€Init DBâ”€â”€â–¶â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚     Create â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚     Schema â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚â—€â”€ Choose â”€â”€â”€â”€â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚   Source     â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚â”€ CloudWatch â–¶â”‚â”€ Fetch â”€â”€â”€â”€â”€â–¶             â”‚            â”‚             â”‚
  â”‚  or S3       â”‚  Configs    â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚â—€â”€ Return â”€â”€â”€â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚   Web ACLs  â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ Store â”€â”€â”€â–¶â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚   Configs  â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚â”€ Fetch â”€â”€â”€â”€â”€â–¶             â”‚            â”‚             â”‚
  â”‚              â”‚  Logs       â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚â—€â”€ Return â”€â”€â”€â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚   Raw Logs  â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ Parse â”€â”€â”€â”€â–¶â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚   Logs      â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚â—€â”€ Return â”€â”€â”€â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚  Normalized â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ Insert â”€â”€â–¶â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚   Logs     â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚  (Chunked) â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ Calculate â–¶â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚   Metrics   â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚â—€â”€ Query â”€â”€â”€â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚   DuckDB   â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚â—€â”€ Return â”€â”€â”€â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚   Metrics   â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€Generate â”€â”€â–¶â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚   Report    â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚â—€â”€ Query â”€â”€â”€â”€â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚   Data      â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚â—€â”€ Create â”€â”€â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚   Charts   â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚  (Matplotlib)            â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚â—€â”€ Build â”€â”€â”€â”€â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚   Excel     â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚  (OpenPyXL) â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚â—€â”€ Report â”€â”€â”€â”€â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚   Complete   â”‚             â”‚             â”‚            â”‚             â”‚
  â”‚              â”‚             â”‚             â”‚            â”‚             â”‚
```

## Prerequisites

- **Python 3.9 or higher**
- **AWS CLI** configured with appropriate credentials
- **IAM Permissions**: The AWS profile must have permissions for:
  - `wafv2:ListWebACLs`
  - `wafv2:GetWebACL`
  - `wafv2:ListResourcesForWebACL`
  - `wafv2:GetLoggingConfiguration`
  - `logs:DescribeLogGroups`
  - `logs:FilterLogEvents`
  - `s3:ListBucket`
  - `s3:GetObject`

## Installation

1. **Clone the repository**:
   ```bash
   git clone <repository-url>
   cd aws-waf-review
   ```

2. **Create a virtual environment** (recommended):
   ```bash
   python3 -m venv venv
   source venv/bin/activate  # On macOS/Linux
   # OR
   .\venv\Scripts\activate  # On Windows
   ```

3. **Install dependencies**:
   ```bash
   pip install -r requirements.txt
   ```

## Configuration

### AWS Credentials

Configure AWS CLI with your profile:

```bash
aws configure --profile <profile-name>
```

Or export AWS credentials:

```bash
export AWS_PROFILE=<profile-name>
export AWS_DEFAULT_REGION=<region>
```

### Verify Access

Test your AWS access:

```bash
aws wafv2 list-web-acls --scope REGIONAL
aws logs describe-log-groups --log-group-name-prefix aws-waf-logs
```

## Usage

> **Note**: Use the `waf-analyzer.py` launcher script in the root directory to run the tool. This handles Python path configuration automatically.

### Interactive Mode (Default)

Run the analyzer without arguments for a guided, menu-driven experience:

```bash
python3 waf-analyzer.py
```

Or make it executable and run directly:

```bash
chmod +x waf-analyzer.py
./waf-analyzer.py
```

**Alternative (using Python module syntax)**:
```bash
python3 -m src.main  # Run from project root directory
```

You'll see an interactive menu:

```
ğŸ¯ What would you like to do?
================================================================================
1. Fetch WAF Configurations (Web ACLs, Rules, Resources)
2. Fetch WAF Logs (CloudWatch or S3)
3. View Current Inventory (Web ACLs and Resources)
4. Generate Excel Report
5. View Database Statistics
0. Exit
================================================================================
```

**Interactive workflow:**
1. Select **Option 1** to fetch WAF configurations
   - Choose scope: REGIONAL, CLOUDFRONT, or both
   - View detailed inventory of Web ACLs and protected resources
2. Select **Option 3** to review what was fetched
3. Select **Option 2** to fetch logs
   - Choose time window: today, yesterday, past week, 3 months, 6 months, or custom range
   - Select log source: CloudWatch (auto-detected from database) or S3
   - CloudWatch log groups automatically discovered from Web ACL logging configurations
4. Select **Option 4** to generate Excel report
   - Choose specific Web ACL or all Web ACLs
   - Reports saved as `{alias}_{account_id}_{timestamp}_waf_report.xlsx`
5. Select **Option 0** to exit

**Advantages of interactive mode:**
- No need to remember CLI arguments
- Visual feedback with inventory display
- Multiple operations in one session
- Input validation and helpful prompts
- Perfect for ad-hoc security analysis

### Non-Interactive Mode (Scripting)

For automation and CI/CD pipelines, provide all arguments:

```bash
python3 waf-analyzer.py \
  --scope REGIONAL \
  --log-source cloudwatch \
  --log-group aws-waf-logs-myapp \
  --months 6 \
  --output report.xlsx \
  --non-interactive
```

### Command-Line Options

```bash
python3 waf-analyzer.py [OPTIONS]

Options:
  --db-path PATH          Path to DuckDB database file
                          (default: data/{account_id}/{account_id}_waf_analysis.duckdb)
  --months {3,6}          Number of months of logs to analyze (3 or 6)
                          Note: Interactive mode offers more options (today, yesterday, week, custom)
  --scope {REGIONAL,CLOUDFRONT}  WAF scope to analyze
  --skip-config           Skip fetching WAF configurations
  --skip-logs             Skip fetching logs
  --log-source {cloudwatch,s3}  Log source (cloudwatch or s3)
  --log-group NAME        CloudWatch log group name
                          Note: Interactive mode auto-detects from Web ACL logging config
  --s3-bucket NAME        S3 bucket name
  --s3-prefix PREFIX      S3 key prefix
  --output PATH           Output Excel report filename
                          (default: output/{account_id}/{account_id}_{timestamp}_waf_report.xlsx)
  --non-interactive       Run in non-interactive mode (no prompts)
```

### Example Usage Scenarios

**Analyze 6 months of CloudWatch logs**:
```bash
python3 waf-analyzer.py --months 6 --log-source cloudwatch --log-group aws-waf-logs-myapp
```

**Analyze S3 logs for CloudFront WAF**:
```bash
python3 waf-analyzer.py --scope CLOUDFRONT --log-source s3 \
  --s3-bucket my-waf-logs --s3-prefix cloudfront/waf/
```

**Generate report from existing database**:
```bash
python3 waf-analyzer.py --skip-config --skip-logs --output custom_report.xlsx
```

**Fetch configs only (no logs)**:
```bash
python3 waf-analyzer.py --skip-logs
```

**Interactive mode - view inventory first**:
```bash
python3 waf-analyzer.py
# Select option 1: Fetch configurations
# Select option 3: View inventory
# Review Web ACLs, then decide on next steps
```

### Web ACL Inventory Display

After fetching configurations in interactive mode, you'll see a detailed inventory:

```
================================================================================
ğŸ“‹ Web ACL Inventory
================================================================================

1. Production-WebACL
   Scope: REGIONAL
   Default Action: ALLOW
   Capacity: 1500 WCU
   Rules: 12
   Protected Resources: 3
     - ALB: my-production-alb
     - ALB: api-gateway-alb
     - API_GATEWAY: my-rest-api
   Logging: âœ“ Enabled (CloudWatch)

2. Staging-WebACL
   Scope: REGIONAL
   Default Action: ALLOW
   Capacity: 800 WCU
   Rules: 8
   Protected Resources: 1
     - ALB: staging-alb
   Logging: âœ— Not configured

================================================================================
```

**Inventory includes:**
- Web ACL name, scope (REGIONAL/CLOUDFRONT), default action
- WCU capacity usage
- Number of rules configured
- Protected resources with type and name
- Logging status (enabled/disabled)

### Directory Structure

The tool automatically creates and uses the following account-specific directory structure:

```
aws-waf-review/
â”œâ”€â”€ data/{alias}_{account_id}/        # Account-specific DuckDB files (auto-created)
â”‚   â””â”€â”€ {alias}_{account_id}_waf_analysis.duckdb
â”œâ”€â”€ output/{alias}_{account_id}/      # Account-specific Excel reports (auto-created)
â”‚   â””â”€â”€ {alias}_{account_id}_20251107_123456_waf_report.xlsx
â”œâ”€â”€ logs/{alias}_{account_id}/        # Account-specific application logs (auto-created)
â””â”€â”€ exported-prompt/{alias}_{account_id}/  # Filled prompts with WAF data (auto-created, gitignored)
```

**Multi-Account Organization:**
- Each AWS account gets separate subdirectories for complete data isolation
- Account ID and alias (if set) automatically detected using AWS STS and IAM
- Directory naming format: `{alias}_{account_id}` (falls back to `{account_id}` if no alias)
- Database files: `{alias}_{account_id}_waf_analysis.duckdb`
- Reports: `{alias}_{account_id}_{timestamp}_waf_report.xlsx`
- All generated files are excluded from git via `.gitignore`

**Account Alias:**
- AWS account alias (friendly name) is automatically fetched if configured
- Requires `iam:ListAccountAliases` permission (gracefully handles denial)
- Makes multi-account analysis more user-friendly with recognizable names

## Excel Report Structure

The generated Excel report contains **8 professional sheets** with comprehensive analysis:

### 1. Executive Summary
- **Web ACLs Overview** section with detailed configuration for each Web ACL
- High-level metrics and KPIs with professional formatting
- **Security Posture Score** (color-coded: Green â‰¥80, Orange â‰¥60, Red <60)
- Action distribution pie charts
- Time range and coverage information
- Key security metrics with alternating row highlighting
- Professional styling with 18pt titles and generation timestamps

### 2. Inventory
- **Web ACLs Configuration** table with rules count and resources count
- **Rule Implementation Summary** â­ NEW
  - Total rules configured
  - Rules breakdown by type (with percentages)
  - Rules breakdown by action (BLOCK, ALLOW, COUNT, etc. with percentages)
  - Color-coded actions for easy identification
- **Rules and Rule Groups** detailed table sorted by Web ACL and priority
- **Protected Resources** (ALB, API Gateway, CloudFront, AppSync, Cognito, etc.)
- Logging status with color-coding (red for disabled, green for enabled)

### 3. Traffic Analysis
- Daily traffic trends (line charts with blocked/allowed breakdown)
- Geographic distribution of traffic and threats
- Top 20 countries by request volume
- Threat scores by geography with color-coding
- Geographic threat visualization chart

### 4. Rule Effectiveness
- Rule performance metrics (hit count, block rate, effectiveness percentage)
- Rules with 0% hit rate highlighted in red (potentially redundant)
- Attack type distribution with horizontal bar chart
- Top 15 blocking rules with visualizations
- Color-coded effectiveness indicators

### 5. Geographic Distribution of Blocked Traffic â­ NEW
- **Purpose**: Identifies geographic origins of blocked requests to detect malicious traffic sources
- **Blocked Traffic Summary** with key statistics:
  - Total blocked requests
  - Number of countries with blocked traffic
  - Top blocking country identification
- **Top 30 Countries** by blocked requests with:
  - Block rate percentage
  - **Threat Level** assessment (CRITICAL, HIGH, MEDIUM, LOW)
  - **Risk Assessment** with actionable insights
  - Color-coded threat levels for immediate visual identification
- Geographic visualization chart

### 6. Rule Action Distribution â­ NEW
- **Purpose**: Evaluates rule effectiveness and identifies optimization opportunities
- **Overall Action Distribution**:
  - Breakdown by action type (BLOCK, ALLOW, COUNT, CAPTCHA, CHALLENGE)
  - Security impact assessment for each action
  - Action-specific recommendations
  - Color-coded action types
- **Rule-Level Analysis** (top 50 rules):
  - Total hits, blocks, allows, block rate
  - **Effectiveness rating** (HIGHLY EFFECTIVE, EFFECTIVE, MODERATE, LOW, UNUSED)
  - **Status recommendations** for optimization
  - Color-coded effectiveness indicators
- Action distribution visualization chart

### 7. Client Analysis
- Top 30 blocked IP addresses with detailed tracking
- Bot traffic analysis (JA3/JA4 fingerprints)
- User-Agent patterns analysis
- Hourly traffic patterns with grouped bar charts

### 8. LLM Recommendations
- Professional template for AI-generated security findings
- Four priority sections with color-coded headers:
  - ğŸ”´ Critical Findings (immediate action) - Red
  - ğŸŸ  High Priority (30 days) - Orange
  - ğŸŸ¡ Medium Priority (90 days) - Yellow
  - ğŸŸ¢ Low Priority (nice to have) - Green
- Structured format with: Priority, Finding/Recommendation, Impact, Action Items
- Pre-formatted with professional borders and alternating row colors

### Professional Styling Features
- âœ… Consistent professional blue theme (#1F4E78) throughout
- âœ… 18pt titles with generation timestamps on every sheet
- âœ… Alternating row colors for better readability
- âœ… Professional borders on all data cells
- âœ… Color-coded status indicators (green for good, red for issues, orange for warnings)
- âœ… Auto-adjusted column widths for optimal display
- âœ… Merged cells for section headers
- âœ… Right-aligned numeric values for easy scanning
- âœ… Embedded visualization charts at 150 DPI

## LLM Prompt Templates

The `config/prompts/` directory contains markdown templates for AI-powered analysis:

> **Auto-filled exports**: When you generate an Excel report, the tool now spins up `exported-prompt/{alias}_{account_id}/` with every placeholder already populated using the latest metrics, rule data, and attack summaries. You can still edit the templates manually, but most workflows can now copy/paste the enriched exports directly into your preferred LLM.

### comprehensive_waf_analysis.md
Master prompt template that combines all security analysis areas:
- **Executive Summary**: Security posture score and critical findings
- **Rule Effectiveness**: Unused rules, low-performing rules, ordering optimization
- **False Positive Analysis**: Identify legitimate traffic being blocked
- **Threat Intelligence**: Primary attack vectors, bot traffic, persistent threats
- **Geographic Assessment**: High-risk countries and geo-blocking strategy
- **Compliance Review**: OWASP Top 10, PCI-DSS 6.6, AWS Well-Architected
- **Cost Optimization**: WCU reduction opportunities
- **Implementation Roadmap**: Prioritized action plan

**Usage Options**:

**Option 1 - Manual (No AWS Bedrock needed)**:
1. Run the analyzer and select "Export Excel Report + Generate LLM Prompt"
2. Prompt file auto-generated with all WAF metrics injected at `output/{alias}_{account_id}/waf_analysis_YYYY-MM-DD_llm_prompt.md`
3. Copy content and paste into ChatGPT/Claude/Gemini
4. Copy AI response and paste into "LLM Recommendations" sheet in Excel

**Option 2 - Auto (AWS Bedrock)**:
1. Run the analyzer and select "Export Excel Report + Auto-Analyze with LLM"
2. Choose LLM model (Claude 3.5 Sonnet recommended for accuracy & conciseness)
3. Analysis runs automatically via AWS Bedrock API
4. Excel "LLM Recommendations" sheet auto-populated with findings
5. Cost: ~$1.50-3.00 per analysis

**Supported Models** (all via AWS Bedrock):
- **Claude 3.5 Sonnet** - Recommended for accurate, concise analysis
- **Claude 3 Haiku** - Fastest & cheapest option
- **OpenAI GPT-OSS 120B** - Production-grade reasoning
- **OpenAI GPT-OSS 20B** - Fast analysis

## Database Schema

The tool uses DuckDB with the following tables:

- **web_acls**: Web ACL configurations
- **rules**: Individual WAF rules
- **resource_associations**: Resources protected by each Web ACL
- **logging_configurations**: Logging destinations and settings
- **waf_logs**: Parsed WAF log entries with full metadata



## Security Metrics Calculated

- **Summary Metrics**: Total requests, block rate, unique IPs, countries
- **Action Distribution**: Breakdown of ALLOW, BLOCK, COUNT, CAPTCHA, CHALLENGE actions
- **Rule Effectiveness**: Hit rate, block rate, and effectiveness score per rule
- **Geographic Distribution**: Traffic and threat patterns by country
- **Attack Type Classification**: SQL injection, XSS, scanners, bots, etc.
- **Temporal Patterns**: Hourly and daily traffic trends
- **Bot Analysis**: JA3/JA4 fingerprint analysis, user-agent patterns
- **Security Posture Score**: 0-100 score based on coverage, effectiveness, and configuration

## Troubleshooting

### No Web ACLs Found

**Issue**: "No Web ACLs found in REGIONAL scope"

**Solutions**:
- Verify you're using the correct AWS profile and region
- Try `--scope CLOUDFRONT` if analyzing CloudFront WAFs
- Check IAM permissions for `wafv2:ListWebACLs`

### No Logs Found

**Issue**: "No log events found in CloudWatch"

**Solutions**:
- Verify logging is enabled for your Web ACL
- Check the log group name (should start with `aws-waf-logs-`)
- Adjust the time window with `--months 6`
- Verify IAM permissions for CloudWatch Logs

### Access Denied Errors

**Issue**: "Access denied" when fetching data

**Solutions**:
- Run `aws sts get-caller-identity` to verify credentials
- Check IAM permissions listed in Prerequisites
- Ensure you have access to the specific resources (log groups, S3 buckets)

### Memory Issues with Large Datasets

**Issue**: Out of memory when processing millions of logs

**Solutions**:
- The tool uses chunked processing for large S3 datasets
- For CloudWatch, consider breaking into smaller time windows
- Increase available RAM or use a machine with more memory

### Import Errors

**Issue**: "ModuleNotFoundError" when running

**Solutions**:
- Ensure you're in the virtual environment: `source venv/bin/activate`
- Reinstall dependencies: `pip install -r requirements.txt`
- Verify Python version: `python --version` (must be 3.9+)

## Performance Considerations

- **CloudWatch Logs**: Rate limited to 5 TPS per region. Large queries may take time.
- **S3 Logs**: Faster than CloudWatch but requires scanning date-based prefixes
- **Database Size**: Expect ~100-200 bytes per log entry in DuckDB
- **Excel Generation**: Charts are generated as embedded images; large datasets may take several minutes

## Best Practices

1. **Start Small**: Begin with 3 months of logs to understand data volume
2. **Regular Analysis**: Run monthly to track security posture trends
3. **Validate AI Recommendations**: Always review LLM suggestions before implementing
4. **Backup Databases**: The DuckDB file contains all your analysis data
5. **Version Control Configs**: Keep snapshots of WAF configurations over time
6. **Incremental Updates**: Use `--skip-config` when only updating logs

## Advanced Usage

### Custom SQL Queries

```python
from src.storage.duckdb_manager import DuckDBManager

db = DuckDBManager('waf_analysis.duckdb')
conn = db.get_connection()

# Custom analysis
result = conn.execute("""
    SELECT
        DATE(timestamp) as date,
        terminating_rule_id,
        COUNT(*) as blocks
    FROM waf_logs
    WHERE action = 'BLOCK'
    GROUP BY date, terminating_rule_id
    ORDER BY date, blocks DESC
""").df()

print(result)
```

### Export to Parquet

```bash
duckdb waf_analysis.duckdb -c "COPY waf_logs TO 'waf_logs.parquet' (FORMAT PARQUET)"
```

### Programmatic Access

```python
from src.processors.metrics_calculator import MetricsCalculator
from src.storage.duckdb_manager import DuckDBManager

db = DuckDBManager('waf_analysis.duckdb')
calculator = MetricsCalculator(db)

# Get specific metrics
summary = calculator.get_summary_metrics()
rules = calculator.get_rule_effectiveness()
geo = calculator.get_geographic_distribution()

print(f"Total requests: {summary['total_requests']}")
print(f"Block rate: {summary['block_rate_percent']}%")
```

## Contributing

Contributions are welcome! Areas for improvement:

- Additional visualization types
- Support for WAF v1 (Classic)
- Integration with SIEM platforms
- Real-time monitoring mode
- Automated remediation suggestions
- Custom rule development assistance
